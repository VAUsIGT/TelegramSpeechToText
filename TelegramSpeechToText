import telebot
import subprocess
import os
import json
import uuid
from vosk import Model, KaldiRecognizer

# –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –º–æ–¥–µ–ª–∏ Vosk
model = Model("model1")  # –ø—É—Ç—å –∫ –º–æ–¥–µ–ª–∏
bot = telebot.TeleBot("")  # —Ç–æ–∫–µ–Ω

# –£–∫–∞–∂–∏—Ç–µ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ ffmpeg.exe (–ø—Ä–∏–º–µ—Ä –¥–ª—è Windows)
FFMPEG_PATH = r"C:\ffmpeg\bin\ffmpeg.exe"

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ä—Ç–∞
@bot.message_handler(commands=['start'])
def start_handler(message):
    global user_states
    user_id = message.chat.id
    print(f"–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
    bot.send_message(user_id,"üòâ –ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ –±–æ—Ç –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏—à–ª–∏ —Å—é–¥–∞ –ì–° –∏ —è –æ—Ç–ø—Ä–∞–≤–ª—é —Ç–µ–±–µ —Ç–µ–∫—Å—Ç –∏–∑ –Ω–µ–≥–æ.")

@bot.message_handler(content_types=['voice'])
def handle_voice(message):
    print(f"–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.chat.id} –ø—Ä–∏—Å–ª–∞–ª –≥–æ–ª–æ—Å–æ–≤–æ–µ")

    try:
        file_id = str(uuid.uuid4())
        ogg_filename = f"{file_id}.ogg"
        wav_filename = f"{file_id}.wav"

        # –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        file_info = bot.get_file(message.voice.file_id)
        downloaded_file = bot.download_file(file_info.file_path)

        with open(ogg_filename, 'wb') as f:
            f.write(downloaded_file)

        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Å —è–≤–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—É—Ç–∏ –∫ ffmpeg
        command = [
            FFMPEG_PATH,
            '-i', ogg_filename,
            '-ar', '16000',
            '-ac', '1',
            '-y',
            wav_filename
        ]

        subprocess.run(command, check=True,
                       stdout=subprocess.PIPE,
                       stderr=subprocess.PIPE,
                       creationflags=subprocess.CREATE_NO_WINDOW)

        # –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        recognizer = KaldiRecognizer(model, 16000)

        with open(wav_filename, 'rb') as f:
            audio_data = f.read()

        if recognizer.AcceptWaveform(audio_data):
            result = json.loads(recognizer.Result())
            text = "–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ:\n" + result.get('text', '')
        else:
            text = "–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ:\n" + (recognizer.Result())[14:-3]#"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ä–µ—á—å"
        #print(text)

        bot.reply_to(message, text if text else "–†–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞")

    except Exception as e:
        bot.reply_to(message, f"–û—à–∏–±–∫–∞: {str(e)}")

    finally:
        for filename in [ogg_filename, wav_filename]:
            if os.path.exists(filename):
                os.remove(filename)

print("------------------–±–æ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω---------------------")
bot.polling()
